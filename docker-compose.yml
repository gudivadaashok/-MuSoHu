# Docker Compose Configuration for MuSoHu
# Works on both macOS and Linux
# 
# For Linux with GPU/device support:
#   Set ENABLE_GPU=true and ENABLE_DEVICES=true before running
#   export ENABLE_GPU=true ENABLE_DEVICES=true
#   docker-compose up -d --build

services:
  ros2_vnc:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: ros2_vnc
    # hostname: robotixx
    ports:
      - "6080:80"
    volumes:
      - .:/workspace
      - ~/Desktop/Docker-Volumns/ros2_workspace:/home/ubuntu/ros2_ws
      - ~/Desktop/Docker-Volumns/ros2_logs:/home/ubuntu/.ros/log
      - ~/Desktop/Docker-Volumns/user_data:/home/ubuntu/user_data
      # # Mount ZED SDK from host (read-only)
      # - /usr/local/zed:/usr/local/zed:ro
      # # Mount CUDA from host for ZED compilation
      # - /usr/local/cuda:/usr/local/cuda:ro
    shm_size: 512m
    security_opt:
      - seccomp:unconfined
    restart: unless-stopped
    environment:
      - DISPLAY=:1
      - VNC_PASSWORD=ubuntu
      - ZED_CAMERA_MODEL=zed2i
      - LD_LIBRARY_PATH=/usr/local/zed/lib:$LD_LIBRARY_PATH
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - ros2_network

  web_app:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    container_name: musohu_webapp
    hostname: robotixx-webapp
    ports:
      - "5001:5001"
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/Desktop/Docker-Volumns/app_logs:/app/logs
      - ~/Desktop/Docker-Volumns/app_data:/app/data
      - ~/Desktop/Docker-Volumns/user_data:/app/users
    depends_on:
      - ros2_vnc
    restart: unless-stopped
    environment:
      - FLASK_ENV=development
      - FLASK_APP=ros2_script_manager/app.py
    networks:
      - ros2_network
    working_dir: /workspace

networks:
  ros2_network:
    driver: bridge

volumes:
  ros2_workspace:
    driver: local